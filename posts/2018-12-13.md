# 2018년 12월 13일

## 스쿨 대시보드 CRA v2 마이그레이션

CRA(create-react-app) v1을 기반으로 개발되었던 스쿨 대시보드 앱을 v2로 마이그레이션하는 작업을 진행했다. v1 기반의 기존 앱에서 몇 가지 문제라고 느꼈던 부분을 해결하기 위함이었다.

먼저, 기존 앱에서 Webpack의 트리 쉐이킹이 제대로 동작하지 않고 있다는 느낌을 받았다. Material UI의 컴포넌트를 import하는 코드를 간결하게 하고자 default export가 아닌 named export 형식으로 불러오도록 작성했는데, 이 부분에서 관련 설정을 제대로 추가하지 않으면 최종 번들된 JS 파일의 용량이 커져버린다는 문제를 갖고 있었다. 구글링을 통해 관련 설정 코드를 추가하였고 어느 정도 용량을 줄이는 데 성공했지만, 기존보다 조금 줄어들었을 뿐 여전히 만족스러운 정도는 아니었다.

그런데 CRA v1은 Webpack v3를 사용하는 반면 v2는 Webpack v4를 사용한다. 자세히 알지는 못하지만 Webpack v4는 트리 쉐이킹 작업에 대해 더 최적화된 설정을 제공하고 있기 때문에, v2로 마이그레이션할 시 이 문제에 대한 고민을 해결할 수 있을 것으로 기대했다.

HMR 속도에도 심각한 문제가 있었다. 앱의 규모가 커질수록 저장 후 화면이 갱신되기까지의 시간이 지나치게 길어져버렸는데, 대충 평균 10초 정도 걸렸던 것 같다.. 이 역시 트리 쉐이킹과도 관련된 문제라 생각이 드는데, 너무 느려져버린 HMR 속도는 생산성을 엄청나게 떨어트리는 결과로 이어질 수 밖에 없었다. 다행히 v2로 마이그레이션 후 리로딩까지 걸리는 시간은 1초로 줄어들었다!

그리고, 시간이 지날수록 레거시 코드가 되어버리는 사실이 마음에 걸렸다. 직접 개발해서 실제 운영까지 배포한 첫 프로젝트이기 때문에 꾸준하게 잘 관리하고 싶은 욕심이 있었는데, 그러기 위해서는 현재 앱에서 의존성을 갖고 있는 라이브러리들의 안정화 버전 업데이트를 꾸준하게 진행해줘야 할 필요가 있다고 생각했다. CRA v2가 릴리즈된지 어느 정도 시간이 지나서 안정화 단계에 접어들었고 장기적으로 봤을 때 더 좋은 결정이라고 판단했기 때문에, 다소 힘들더라도 마이그레이션을 진행하기로 했다.

공식 문서에서 안내하고 있는 것처럼, eject 명령을 실행하지 않은 상태라면 마이그레이션 작업이 수월했겠지만 이미 eject 명령을 실행한 상태라서 아예 프로젝트를 새로 만드는 방법을 택했다. 아예 새로 만드는 김에 사용 중인 라이브러리들의 메이저 버전 업데이트까지 함께 진행했는데, `styled-components`, `@material-ui/core`, `react-pdf` 등 3개의 라이브러리에서 큰 변경사항이 있었다.

`styled-components`는 메이저 버전을 3에서 4로 올렸다. 먼저, React v16에서 소개된 `React.forwardRef` API 덕분에 v4 버전에서는 styled 컴포넌트에 `innerRef`라는 이름 대신 `ref` prop을 그대로 사용할 수 있게 되었다(`innerRef`는 향후 deprecated될 예정). 또한 글로벌 스타일을 선언하기 위해 imperative한 방식으로 사용하던 `injectGlobal`이 deprecated되었고, declartive한 방식으로 사용할 수 있는 `createGlobal`이 소개됨에 따라 이와 관련된 부분의 코드를 모두 새로운 방식으로 변경하였다.

UI 라이브러리로는 `@material-ui/core`를 사용하고 있는데, 프로젝트를 처음 시작할 때는 베타 버전을 사용하다가 도중에 정식 버전 v1이 릴리즈되면서 버전을 한 번 업그레이드한 적이 있었다. v1이 나온지도 얼마 되지 않은 것 같은데, 현재 최신 버전은 벌써 v3.6.2인데다가 내년 초에는 v4가 릴리즈 예정인 상태다. 공식 문서도 이미 v3에 맞춰서 많은 내용이 업데이트되었기 때문에, 최신 버전에 뒤쳐지지 않기 위해 업그레이드를 진행했다. 업그레이드를 진행하고 나니 커스터마이징해놓은 UI 컴포넌트들에 조금씩 뒤틀리는 부분이 생겨서(특히 다이얼로그) 관련 UI 코드를 수정했고, `Typography`에서 deprecated될 예정인 `variant`들의 사용을 제거했다.

`react-pdf`는 기존에 사용하던 v3가 Webpack v4와 잘 호환되지 않는 것 같았다. 이에 따라 버전을 v4로 업데이트한 후 PDF.js worker를 사용하도록 코드를 변경했다.

꽤 힘든 작업이었지만, 그래도 다 마치고 나니 마음이 한결 놓이는 듯하다. Storybook 및 테스트 관련 설정 코드도 손을 좀 봐야하지만 현재 우선적으로 개발해야 할 새 피쳐가 있다. 새 피쳐 개발을 완료하고 나서 리프레시 휴가 기간에 이 부분에도 손을 좀 볼 예정이다.